#!/usr/bin/env bash

get_copilot_token() {
    if [ -n "$COPILOT_TOKEN" ]; then
        echo "$COPILOT_TOKEN"
    else
        hosts_file="$HOME/.config/github-copilot/hosts.json"
        if [ -f "$hosts_file" ]; then
            oauth_token=$(jq -r '.["github.com"]["oauth_token"]' "$hosts_file")
            echo "$oauth_token"
        else
            echo "Please set COPILOT_TOKEN environment variable or install Github Copilot extension" >&2
            exit 1
        fi
    fi
}

get_bearer() {
    copilot_token=$(get_copilot_token)
    headers=(
        "authorization: token $copilot_token"
        "editor-version: vscode/1.79.0-insider"
        "editor-plugin-version: copilot/1.86.112"
        "user-agent: GithubCopilot/1.86.112"
        "accept: */*"
    )

    response=$(curl -s -H "${headers[@]}" "https://api.github.com/copilot_internal/v2/token")
    token=$(echo "$response" | jq -r '.token')

    echo "$token"
}

export OPENAI_API_KEY=$(get_bearer)
export OPENAI_API_HOST=https://copilot-proxy.githubusercontent.com

sgpt "$@"
